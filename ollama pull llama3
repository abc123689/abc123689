<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对话式AI助手</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui; }
        body { background: #f5f5f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .chat-box { height: 70vh; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: white; }
        .msg { margin: 10px 0; padding: 12px; border-radius: 8px; max-width: 80%; }
        .user-msg { background: #0071e3; color: white; margin-left: auto; }
        .ai-msg { background: #f0f0f0; color: #333; margin-right: auto; }
        .input-area { display: flex; gap: 10px; }
        #msg-input { flex: 1; padding: 12px; border: 1px solid #eee; border-radius: 24px; outline: none; }
        #send-btn { padding: 12px 24px; background: #0071e3; color: white; border: none; border-radius: 24px; cursor: pointer; }
        #send-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="chat-box" id="chatBox"></div>
    <div class="input-area">
        <input type="text" id="msg-input" placeholder="输入你的问题，按回车或点击发送...">
        <button id="send-btn" onclick="sendMsg()">发送</button>
    </div>

    <script>
        // 上下文记忆（存储对话历史）
        let chatHistory = [];
        const chatBox = document.getElementById('chatBox');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');

        // 发送消息
        async function sendMsg() {
            const userMsg = msgInput.value.trim();
            if (!userMsg) return;

            // 添加用户消息到界面
            addMsgToChat(userMsg, 'user');
            msgInput.value = '';
            sendBtn.disabled = true;

            // 更新对话历史
            chatHistory.push({ role: 'user', content: userMsg });

            try {
                // 调用本地Ollama API
                const response = await fetch('http://localhost:11434/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'llama3', // 替换为你拉取的模型名（如qwen、gemma）
                        messages: chatHistory,
                        stream: false // 关闭流式输出，简单版用同步返回
                    })
                });

                const data = await response.json();
                const aiMsg = data.message.content;
                // 添加AI消息到界面
                addMsgToChat(aiMsg, 'ai');
                // 更新对话历史
                chatHistory.push({ role: 'assistant', content: aiMsg });
            } catch (error) {
                addMsgToChat('抱歉，AI服务暂时不可用，请检查Ollama是否启动！', 'ai');
            } finally {
                sendBtn.disabled = false;
            }
        }

        // 添加消息到聊天界面
        function addMsgToChat(content, type) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${type}-msg`;
            msgDiv.textContent = content;
            chatBox.appendChild(msgDiv);
            // 滚动到底部
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 回车发送
        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMsg();
        });

        // 初始化欢迎语
        addMsgToChat('你好！我是对话式AI助手，有什么可以帮你的？', 'ai');
    </script>
</body>
</html>
